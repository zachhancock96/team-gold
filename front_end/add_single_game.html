<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/style.css">
	<title>Add Game</title>
	<link rel="stylesheet" type="text/css" href="css/jquery.datetimepicker.css"/>
</head>

<body>
	<header>
		Add Game
	</header>
	
	<!--
		Drop down browser banner
		View Games - shows list of games
		Add Manually - shows add games individually
		User Profile - shows user's individual profile
		School Profile - shows user's school profile
	-->
	<table id='banner'>
        <tr>
        <td><a href='./game_view.html'>+ View Games +</a></td>
        <td class='dropdown'>+ Add Games +<div class='dropdown-content'>
          <a href='./add_single_game.html'>Add Manually</a><hr />
          <a href='./file_upload.html'>Upload File</a></div></td>
		<td><a href='./verify_games.html'>+ Verify Games +</a></td>
        <td class='dropdown'>+ Profile +<div class='dropdown-content'>
          <a href='./user_profile.html'>User Profile</a> <hr /> 
          <a href='./school_profile.html'>School Profile</a> <hr />
          <a href='./school_permissions.html'>School Permissions</a></div></td>  
        </tr>
	  </table>
	
	<table id='add__single_game_table'>
		<form id="form">
			
			<tr>
			<td>Home Team:</td>
			<td><input type="text" id="select_home_team" onkeyup="teamFunction()" placeholder="Home Team.." title="Home Team name"></td>
			
			</tr>
		
		<!--	
			<tr>
			<td>Home Team:</td> 
			<td><select id="select_home_team">
			<option value="">Select Team</option></select></td>    
			
			</tr>
		-->

			<tr>
			<td>Visting Team:</td> 
			<td><select id="select_visiting_team">
			<option value="">Select Team</option></select></td>    
			
			</tr>
			
			<tr>
			<td>Start Date:</td> 
			<td><input id="start_date" type="text" placeholder="dd/mm/yyyy"></td>
			</tr>

			<tr>
			<td>Start Time:</td> 
			<td><input id="start_time" type="text" placeholder="hh:mm"></td>
			</tr>
			
			<tr>
			<td>Location:</td> 
			<td><input id="location" type="text" name="location" placeholder="Location"></td>
			</tr>
			
			<tr>
			<td colspan="4"><input id="btn_submit" type="submit" value="Add Game" ></td>
			</tr>
		</form>
	</table>
</body>

<script type='text/JavaScript' src="js/jquery.js"></script>
<script type='text/JavaScript' src="js/jquery2.js"></script>
<script type='text/JavaScript' src="js/api.js"></script>
<script src='js/jquery.datetimepicker.js'></script>
<script src='js/jquery.datetimepicker.full.js'></script>

<script type='text/JavaScript'>

	var options;
	
	function teamFunction() {
		var input, filter, a, i, txtValue, newTeams;
		input = document.getElementById("select_home_team");
		filter = input.value.toUpperCase();
		console.log(options);

		optionsf = "";
		console.log(optionsf);
		for (i = 0; i < teams.length; i++) {
			a = team[i].teamName;
			txtValue = a.textContent || a.innerText;
			if (txtValue.toUpperCase().indexOf(filter) > -1) {
				newTeams.join(a);
			}
		}
	}
	



	//testing api.addGame
	const form = (function() {
		const selectHomeTeamEl = $('#select_home_team');
		const selectVisitingTeamEl = $('#select_visiting_team');		
		const locationEl = $('#location');
		const btnSubmitEl = $('#btn_submit');
		const startDateEl = $('#start_date');
		const startTimeEl = $('#start_time');

		//BEGIN: init date time picker
		$.datetimepicker.setLocale('en');

		startTimeEl.datetimepicker({
			datepicker:false,
			format:'H:i',
			step:15
		});

		startDateEl.datetimepicker({
			yearOffset:0,
			lang:'ch',
			timepicker:false,
			format:'m/d/Y',
			formatDate:'Y/m/d',
			minDate:'-1970/01/02', // yesterday is minimum date
			maxDate:'+3000/01/02' // and tommorow is maximum date calendar
		});	
		//END: init date time picker


		const formEl = $('#form');

		let submitListener = null;

		/*
			@param teams: Array<{
				id,
				teamName
			}>
		*/
		function setTeams(teams) {
			options = teams
				.map(team => `<option value=${team.id}>${team.teamName}</option>`);

			options = ['<option value="">Select team</option>', ...options];
			
			//array to string conversion
			options = options.join('');
			
			//clear select element
			selectHomeTeamEl.empty();
			selectVisitingTeamEl.empty();

			//fill select element
			selectHomeTeamEl.append(options);
			selectVisitingTeamEl.append(options);
		}

		function setSubmitListener(listener) {
			submitListener = listener;
		}

		formEl.on('submit', function(e) {
			e.preventDefault();
			//scrape data out of form elements
			const game = {};
			
			game.homeTeamId = selectHomeTeamEl.val() || null;
			game.awayTeamId = selectVisitingTeamEl.val() || null;
			game.location = locationEl.val() || null;
			

			const dateVal = new Date(startDateEl.val());

			let monthStr = (function() {
				const month = dateVal.getMonth() + 1;
				return month < 10? "0" + month: month + "";
			})();
	
			let dateStr = (function() {
				const date = dateVal.getDate();
				return date < 10? "0" + date: date + "";
			})();


			var formatDate = dateVal.getFullYear() + "-" + monthStr + "-" + dateStr + "T" + startTimeEl.val() + ":00-05:00";
			
			game.start = formatDate || null;
			game.status = 'pend_team' || null;

			console.log(game);

			if(game.homeTeamId){
				game.homeTeamId = parseInt(game.homeTeamId);
			}
			if(game.awayTeamId){
				game.awayTeamId = parseInt(game.awayTeamId);
			}
			// notify listener
			if (submitListener != null) {
				submitListener(game);
			}
		});

		return {
			setTeams,
			setSubmitListener,
		}
	})();


	form.setSubmitListener(game => {
		if (game == null
			|| !game.homeTeamId
			|| !game.awayTeamId
			|| !game.location
			|| !game.start
			|| !game.status) {
				alert('invalid form data');
			}
		else {
			//TODO: add game
			api.addGame(game)
				.then(result => {
                                        alert('success!');
					console.log(game);
					console.log(result);
				})
				.catch(error => {
                  		        alert('Oops!');
					console.log(error);
				})
		}
	});

	
	api.getTeams()
		.then(teams => {
			
			form.setTeams(teams);
		});

	


</script>
</html>